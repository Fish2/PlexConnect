function loadPage(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.send()}function log(e,t){t=t||1;var i=new XMLHttpRequest,n="{{URL(/)}}&PlexConnectATVLogLevel="+t.toString()+"&PlexConnectLog="+encodeURIComponent(e);i.open("GET",n,!1),i.send()}function getMetadata(){mediaURL=atv.player.asset.getTextContent("mediaURL"),isTranscoding=mediaURL.indexOf("transcode/universal")>-1;var e=atv.player.asset.getElementByTagName("myMetadata");null!=e&&(key=e.getTextContent("key"),ratingKey=e.getTextContent("ratingKey"),duration=parseInt(e.getTextContent("duration")),partDuration=parseInt(e.getTextContent("partDuration")),subtitleURL=e.getTextContent("subtitleURL"),log("updateMetadata/getMetadata done")),log("updateMetadata done")}function pad(e,t){return(Array(t).join("0")+e).slice(-t)}function initClockView(){clockView=new atv.TextView;var e=.15*screenFrame.width;"24 Hour"==timeFormat&&(e=.1*screenFrame.width);var t=.06*screenFrame.height,i=.006*parseInt(overscanAdjust),n=.1;if("Center"==clockPosition)var n=.5;else if("Right"==clockPosition)var n=.9;return clockView.backgroundColor={red:0,blue:0,green:0,alpha:.7},clockView.frame={x:screenFrame.x+screenFrame.width*n-.5*e,y:screenFrame.y+screenFrame.height*(.988+i)-t,width:e,height:t},clockTimer=atv.setInterval(updateClock,1e3),updateClock(),clockView}function initEndTimeView(){endTimeView=new atv.TextView;var e=.1*screenFrame.width;"12 Hour"==timeFormat&&(e=.15*screenFrame.width);var t=.03*screenFrame.height,i=.006*parseInt(overscanAdjust),n=.1;if("Center"==clockPosition)var n=.5;else if("Right"==clockPosition)var n=.9;return endTimeView.backgroundColor={red:0,blue:0,green:0,alpha:.7},endTimeView.frame={x:screenFrame.x+screenFrame.width*n-.5*e,y:screenFrame.y+screenFrame.height*(.05-i)-t,width:e,height:t},endTimer=atv.setInterval(updateEndTime,1e3),updateEndTime(),endTimeView}function updateClock(){var e="AM",t=new Date,i=pad(t.getHours(),2),n=parseInt(i);n>12?(n-=12,e="PM"):12==n?e="PM":0==n&&(n=12,e="AM"),hours12=n.toString();var a=pad(t.getMinutes(),2),r=(pad(t.getSeconds(),2),i+":"+a),o=hours12+":"+a+" "+e;clockView.attributedString="24 Hour"==timeFormat?{string:""+r,attributes:{pointSize:36,color:{red:1,blue:1,green:1},alignment:"center"}}:{string:""+o,attributes:{pointSize:36,color:{red:1,blue:1,green:1},alignment:"center"}}}function updateEndTime(){var e="AM",t=new Date,i=parseInt(t.getHours()),n=parseInt(t.getMinutes()),a=parseInt(t.getSeconds()),r=3600*i+60*n+a+remainingTime,o=Math.floor(r/3600);o>=24&&(o-=24);var s=Math.floor(r%3600/60),l=pad(o.toString(),2),d=o;d>12?(d-=12,e="PM"):12==d?e="PM":0==d&&(d=12,e="AM"),hours12=d.toString();var u=pad(s.toString(),2),c=l+":"+u,m=hours12+":"+u+" "+e,g="Ends at:  ";g+="24 Hour"==timeFormat?c:m,0==remainingTime?(g="",endTimeView.backgroundColor={red:0,blue:0,green:0,alpha:0}):endTimeView.backgroundColor={red:0,blue:0,green:0,alpha:.7},endTimeView.attributedString={string:g,attributes:{pointSize:16,color:{red:1,blue:1,green:1},alignment:"center"}}}function initSubtitleView(){for(var e=screenFrame.width,t=1*screenFrame.height/14*subtitleSize/100,i=1*screenFrame.width/640,n=1*screenFrame.height/360,a=0;a<subtitleMaxLines;a++)subtitleView.shadowRB[a]=new atv.TextView,subtitleView.shadowRB[a].backgroundColor={red:0,blue:0,green:0,alpha:0},subtitleView.shadowRB[a].frame={x:screenFrame.x+i,y:screenFrame.y-n+t*(subtitleMaxLines-a-.5),width:e,height:t},subtitleView.subtitle[a]=new atv.TextView,subtitleView.subtitle[a].backgroundColor={red:0,blue:0,green:0,alpha:0},subtitleView.subtitle[a].frame={x:screenFrame.x,y:screenFrame.y+t*(subtitleMaxLines-a-.5),width:e,height:t};return subtitleView}function updateSubtitle(e){for(;subtitlePos>0&&e<subtitle.Timestamp[subtitlePos].time;)subtitlePos--;for(;subtitlePos<subtitle.Timestamp.length-1&&e>subtitle.Timestamp[subtitlePos+1].time;)subtitlePos++;var t;t=subtitle.Timestamp[subtitlePos].Line?Math.min(subtitle.Timestamp[subtitlePos].Line.length,subtitleMaxLines):0;for(var i=0,n=0;n<subtitleMaxLines-t;n++)subtitleView.shadowRB[i].attributedString={string:"",attributes:{pointSize:40*subtitleSize/100,color:{red:0,blue:0,green:0,alpha:1}}},subtitleView.subtitle[i].attributedString={string:"",attributes:{pointSize:40*subtitleSize/100,color:{red:1,blue:1,green:1,alpha:1}}},i++;for(var n=0;n<t;n++)subtitleView.shadowRB[i].attributedString={string:subtitle.Timestamp[subtitlePos].Line[n].text,attributes:{pointSize:40*subtitleSize/100,color:{red:0,blue:0,green:0,alpha:1},weight:subtitle.Timestamp[subtitlePos].Line[n].weight||"normal",alignment:"center",breakMode:"clip"}},subtitleView.subtitle[i].attributedString={string:subtitle.Timestamp[subtitlePos].Line[n].text,attributes:{pointSize:40*subtitleSize/100,color:{red:1,blue:1,green:1,alpha:1},weight:subtitle.Timestamp[subtitlePos].Line[n].weight||"normal",alignment:"center",breakMode:"clip"}},i++;e<1e4&&log("updateSubtitle done, subtitlePos="+subtitlePos)}var baseURL,accessToken,showClock,timeFormat,clockPosition,overscanAdjust,showEndtime,subtitleSize,mediaURL,key,ratingKey,duration,partDuration,subtitleURL,lastReportedTime=-1,lastTranscoderPingTime=-1,remainingTime=0,startTime=0,isTranscoding=!1;atv.player.playerTimeDidChange=function(e){remainingTime=Math.round(duration/1e3-e);var t=Math.round(1e3*e);if(t+=startTime,-1==lastReportedTime||Math.abs(t-lastReportedTime)>5e3){lastReportedTime=t;var i="";""!=accessToken&&(i="&X-Plex-Token="+accessToken),loadPage(baseURL+"/:/timeline?ratingKey="+ratingKey+"&key="+key+"&duration="+duration.toString()+"&state=playing&time="+t.toString()+"&X-Plex-Client-Identifier="+atv.device.udid+"&X-Plex-Device-Name="+encodeURIComponent(atv.device.displayName)+i)}if(isTranscoding&&(-1==lastTranscoderPingTime||Math.abs(t-lastTranscoderPingTime)>6e4)){lastTranscoderPingTime=t;var i="";""!=accessToken&&(i="&X-Plex-Token="+accessToken),loadPage(baseURL+"/video/:/transcode/universal/ping?session="+atv.device.udid+i)}subtitle&&updateSubtitle(t)},atv.player.didStopPlaying=function(){clockTimer&&atv.clearInterval(clockTimer),endTimer&&atv.clearInterval(endTimer),Views=[];var e="";""!=accessToken&&(e="&X-Plex-Token="+accessToken),loadPage(baseURL+"/:/timeline?ratingKey="+ratingKey+"&key="+key+"&duration="+duration.toString()+"&state=stopped&time="+lastReportedTime.toString()+"&X-Plex-Client-Identifier="+atv.device.udid+"&X-Plex-Device-Name="+encodeURIComponent(atv.device.displayName)+e),isTranscoding&&loadPage(baseURL+"/video/:/transcode/universal/stop?session="+atv.device.udid)},atv.player.willStartPlaying=function(){lastReportedTime=-1,lastTranscoderPingTime=-1,remainingTime=0,startTime=0;var e=atv.player.asset.getElementByTagName("videoPlayerSettings");if(null!=e&&(baseURL=e.getTextContent("baseURL"),accessToken=e.getTextContent("accessToken"),showClock=e.getTextContent("showClock"),timeFormat=e.getTextContent("timeFormat"),clockPosition=e.getTextContent("clockPosition"),overscanAdjust=e.getTextContent("overscanAdjust"),showEndtime=e.getTextContent("showEndtime"),subtitleSize=e.getTextContent("subtitleSize"),log("willStartPlaying/getVideoPlayerSettings done")),getMetadata(),subtitle=[],subtitlePos=0,subtitleURL&&(!isTranscoding||isTranscoding&&mediaURL.indexOf("skipSubtitles=1")>-1)){log("subtitleURL: "+subtitleURL);var t=new XMLHttpRequest;t.onreadystatechange=function(){4==t.readyState&&(subtitle=JSON.parse(t.responseText))},t.open("GET",subtitleURL+"&PlexConnectUDID="+atv.device.udid,!0),t.send(),log("willStartPlaying/parseSubtitleJSON done")}var i=[],n={type:"BasicAnimation",keyPath:"opacity",fromValue:0,toValue:0,duration:0,removedOnCompletion:!1,fillMode:"forwards",animationDidStop:function(e){}};if(containerView.frame=screenFrame,"True"==showClock&&(clockView=initClockView(),i.push(clockView),clockView.addAnimation(n,clockView)),duration>0&&"True"==showEndtime&&(endTimeView=initEndTimeView(),i.push(endTimeView),endTimeView.addAnimation(n,endTimeView)),log("willStartPlaying/createClockView done"),subtitleURL&&(!isTranscoding||isTranscoding&&mediaURL.indexOf("skipSubtitles=1")>-1)){subtitleView=initSubtitleView();for(var a=0;a<subtitleMaxLines;a++)i.push(subtitleView.shadowRB[a]),i.push(subtitleView.subtitle[a]);log("willStartPlaying/createSubtitleView done")}containerView.subviews=i,atv.player.overlay=containerView,log("willStartPlaying done")};var assettimer=null;atv.player.loadMoreAssets=function(e){assettimer=atv.setInterval(function(){atv.clearInterval(assettimer);var t=atv.player.asset,i=t.getElementsByTagName("httpFileVideoAsset");null!=i&&i.length>1?i.shift():i=null,e.success(i),log("loadMoreAssets done")},1e3)},atv.player.currentAssetChanged=function(){var e=ratingKey;startTime+=partDuration,getMetadata(),e!=ratingKey&&(startTime=0),log("currentAssetChanged done")},atv.Element&&(atv.Element.prototype.getElementsByTagName=function(e){return this.ownerDocument.evaluateXPath("descendant::"+e,this)},atv.Element.prototype.getElementByTagName=function(e){var t=this.getElementsByTagName(e);if(t&&t.length>0)return t[0]},atv.Element.prototype.getTextContent=function(e){var t=this.getElementByTagName(e);return t&&t.textContent?t.textContent:""}),atv.player.onTransportControlsDisplayed=function(e){var t={type:"BasicAnimation",keyPath:"opacity",fromValue:0,toValue:1,duration:e,removedOnCompletion:!1,fillMode:"forwards",animationDidStop:function(e){}};"True"==showClock&&clockView.addAnimation(t,clockView),"True"==showEndtime&&endTimeView.addAnimation(t,endTimeView)},atv.player.onTransportControlsHidden=function(e){var t={type:"BasicAnimation",keyPath:"opacity",fromValue:1,toValue:0,duration:e,removedOnCompletion:!1,fillMode:"forwards",animationDidStop:function(e){}};"True"==showClock&&clockView.addAnimation(t,clockView),"True"==showEndtime&&endTimeView.addAnimation(t,endTimeView)};var pingTimer=null;atv.player.playerStateChanged=function(e,t){if(log("Player state: "+e+" at this time: "+t),state=null,"Paused"==e&&(state="paused",isTranscoding)){var i="";""!=accessToken&&(i="&X-Plex-Token="+accessToken),pingTimer=atv.setInterval(function(){loadPage(baseURL+"/video/:/transcode/universal/ping?session="+atv.device.udid+i)},6e4)}if("Playing"==e&&(state="play",atv.clearInterval(pingTimer)),"Loading"==e&&(state="buffering"),null!=state){var n=Math.round(1e3*t);n+=startTime;var i="";""!=accessToken&&(i="&X-Plex-Token="+accessToken),loadPage(baseURL+"/:/timeline?ratingKey="+ratingKey+"&key="+key+"&duration="+duration.toString()+"&state="+state+"&time="+n.toString()+"&report=1&X-Plex-Client-Identifier="+atv.device.udid+"&X-Plex-Device-Name="+encodeURIComponent(atv.device.displayName)+i)}};var screenFrame=atv.device.screenFrame,containerView=new atv.View,clockView,clockTimer,endTimeView,endTimer,subtitleView={shadowRB:[],subtitle:[]},subtitle=[],subtitlePos=0,subtitleMaxLines=4;atv.config={doesJavaScriptLoadRoot:!0,DEBUG_LEVEL:4},atv.onAppEntry=function(){if(fv=atv.device.softwareVersion.split("."),firmVer=fv[0]+"."+fv[1],parseFloat(firmVer)>=5.1){var e="{{URL(/)}}&PlexConnect=Discover&PlexConnectUDID="+atv.device.udid,t=new XMLHttpRequest;t.open("GET",e,!1),t.send(),atv.loadURL("{{URL(/PlexConnect.xml)}}")}else{var i=atv.parseXML('<?xml version="1.0" encoding="UTF-8"?> <atv>   <body>     <dialog id="com.sample.error-dialog">       <title>{{TEXT(PlexConnect)}}</title>       <description>{{TEXT(ATV firmware version 5.1 or higher required. Please think about updating.)}}</description>     </dialog>   </body> </atv>');atv.loadXML(i)}},atv.onGenerateRequest=function(e){if(-1!=e.url.indexOf("{{URL(/)}}")){var t="&";-1==e.url.indexOf("?")&&-1==e.url.indexOf("&")&&(t="?"),e.url=e.url+t+"PlexConnectUDID="+atv.device.udid,e.url=e.url+"&PlexConnectATVName="+encodeURIComponent(atv.device.displayName)}log("atv.onGenerateRequest done: "+e.url)};